---
const { sources, regions, providers, dataTypes } = Astro.props;
---

<div class="data-filters" data-filters aria-label="Filter data sources">
  <label class="filter-field" for="filter-search">
    <span class="filter-label">Search</span>
    <input id="filter-search" type="search" placeholder="Search title or tags" />
  </label>

  <label class="filter-field" for="filter-region">
    <span class="filter-label">Region</span>
    <select id="filter-region">
      <option value="">All regions</option>
      {regions.map((region) => (
        <option value={region}>{region}</option>
      ))}
    </select>
  </label>

  <label class="filter-field" for="filter-provider">
    <span class="filter-label">Provider</span>
    <select id="filter-provider">
      <option value="">All providers</option>
      {providers.map((provider) => (
        <option value={provider}>{provider}</option>
      ))}
    </select>
  </label>

  <label class="filter-field" for="filter-type">
    <span class="filter-label">Data type</span>
    <select id="filter-type">
      <option value="">All types</option>
      {dataTypes.map((type) => (
        <option value={type}>{type}</option>
      ))}
    </select>
  </label>

  <div class="filter-actions">
    <button class="filter-clear" type="button" id="filter-clear">
      Clear filters
    </button>
  </div>
</div>

<div class="data-table-wrap">
  <table class="data-table" data-table>
        <thead>
          <tr>
            <th class="data-col-title">Source</th>
            <th>Region</th>
            <th>Provider</th>
            <th>Data types</th>
            <th class="data-col-action">More info</th>
          </tr>
        </thead>
    <tbody>
      {sources.map((source) => {
        const tags = source.data.tags ?? [];
        const dataTypeList = source.data.dataTypes ?? [];
        const searchText = [source.data.title, ...tags].join(" ").toLowerCase();
        const licence = source.data.licence?.trim();
        const emptyLabel = "--";
        const licenceLabel = licence && licence.length > 0 ? licence : emptyLabel;
        return (
          <tr
            data-search={searchText}
            data-region={source.data.region.toLowerCase()}
            data-provider={source.data.provider.toLowerCase()}
            data-types={dataTypeList.map((type) => type.toLowerCase()).join("|")}
            data-registration={source.data.registrationRequired ? "yes" : "no"}
          >
            <td class="data-col-title">
              <a href={`/data/${source.slug}`}>{source.data.title}</a>
            </td>
            <td>{source.data.region || emptyLabel}</td>
            <td>{source.data.provider || emptyLabel}</td>
            <td>
              <div class="data-type-list">
                {dataTypeList.length > 0
                  ? dataTypeList.map((type) => <span class="data-pill">{type}</span>)
                  : emptyLabel}
              </div>
            </td>
            <td class="data-col-action">
              <a class="data-external" href={`/data/${source.slug}`}>
                More Info
              </a>
            </td>
          </tr>
        );
      })}
    </tbody>
  </table>
</div>

<script type="module">
  const searchInput = document.getElementById("filter-search");
  const regionSelect = document.getElementById("filter-region");
  const providerSelect = document.getElementById("filter-provider");
  const typeSelect = document.getElementById("filter-type");
  const clearButton = document.getElementById("filter-clear");
  const table = document.querySelector("[data-table]");
  const rows = Array.from(table.querySelectorAll("tbody tr"));

  const toLower = (value) => (value || "").toString().toLowerCase();

  const applyFilters = () => {
    const searchValue = toLower(searchInput.value.trim());
    const regionValue = toLower(regionSelect.value);
    const providerValue = toLower(providerSelect.value);
    const typeValue = toLower(typeSelect.value);
    rows.forEach((row) => {
      const matchesSearch = !searchValue || row.dataset.search.includes(searchValue);
      const matchesRegion = !regionValue || row.dataset.region === regionValue;
      const matchesProvider = !providerValue || row.dataset.provider === providerValue;
      const typeValues = row.dataset.types ? row.dataset.types.split("|") : [];
      const matchesType = !typeValue || typeValues.includes(typeValue);

      row.hidden = !(
        matchesSearch &&
        matchesRegion &&
        matchesProvider &&
        matchesType
      );
    });
  };

  [searchInput, regionSelect, providerSelect, typeSelect].forEach((control) => {
    control.addEventListener("input", applyFilters);
    control.addEventListener("change", applyFilters);
  });

  clearButton.addEventListener("click", () => {
    searchInput.value = "";
    regionSelect.value = "";
    providerSelect.value = "";
    typeSelect.value = "";
    applyFilters();
  });
</script>
