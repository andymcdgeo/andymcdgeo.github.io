---
import BaseLayout from "../../../layouts/BaseLayout.astro";
import Navbar from "../../../components/Navbar.astro";
import { getCollection } from "astro:content";
import { slugifyTag } from "../../../utils/slugifyTag";
import { Image } from "astro:assets";

export async function getStaticPaths() {
  const posts = await getCollection("blog");
  const tags = Array.from(new Set(posts.flatMap((post) => post.data.tags)));
  return tags.map((tag) => ({
    params: { tag: slugifyTag(tag) },
    props: { tag },
  }));
}

const { tag } = Astro.props;
const posts = await getCollection("blog");
const sortedPosts = posts.sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf());
const allTags = Array.from(new Set(posts.flatMap((post) => post.data.tags))).sort((a, b) =>
  a.localeCompare(b)
);
const tagLinks = allTags.map((tagLabel) => ({
  label: tagLabel,
  slug: slugifyTag(tagLabel),
}));
const selectedSlug = slugifyTag(tag);
const filteredPosts = sortedPosts.filter((post) =>
  post.data.tags.some((tagLabel) => slugifyTag(tagLabel) === selectedSlug)
);

const formatDate = (date) =>
  new Intl.DateTimeFormat("en-GB", {
    year: "numeric",
    month: "short",
    day: "2-digit",
  }).format(date);

const stripMarkdown = (text) =>
  text
    .replace(/```[\s\S]*?```/g, "")
    .replace(/`[^`]*`/g, "")
    .replace(/!\[[^\]]*\]\([^)]*\)/g, "")
    .replace(/\[[^\]]*\]\([^)]*\)/g, "")
    .replace(/[#>*_~\-]+/g, " ")
    .replace(/\s+/g, " ")
    .trim();

const excerptFor = (post, wordCount = 28) => {
  const description = post.data.description?.trim();
  if (description) return description;
  const cleaned = stripMarkdown(post.body || "");
  if (!cleaned) return "";
  const words = cleaned.split(" ");
  const excerpt = words.slice(0, wordCount).join(" ");
  return words.length > wordCount ? `${excerpt}...` : excerpt;
};
---

<BaseLayout title={`Blog: ${tag} - Andy McDonald`}>
  <Navbar slot="nav" />

  <section class="section">
    <h1>Writing</h1>
    <p class="section-lede">Filtering by tag: {tag}</p>

    <div class="tag-filters" role="list">
      <a href="/blog" class:list={["tag", "tag-link"]}>All</a>
      {tagLinks.map((tagLink) => (
        <a
          href={`/blog/tag/${tagLink.slug}`}
          class:list={["tag", "tag-link", tagLink.slug === selectedSlug && "is-active"]}
          data-tag={tagLink.slug}
        >
          {tagLink.label}
        </a>
      ))}
    </div>

    {filteredPosts.length === 0 ? (
      <p class="section-lede">
        No posts found for "{tag}". <a class="section-link" href="/blog">Show all posts</a>.
      </p>
    ) : (
      <div class="blog-grid">
        {filteredPosts.map((post) => (
          <article class="blog-card">
            <a class="blog-image" href={`/blog/${post.slug}`}>
              <Image
                src={post.data.heroImage}
                alt={post.data.heroImageAlt}
                width={post.data.heroImage.width}
                height={post.data.heroImage.height}
                loading="lazy"
              />
            </a>
            <div class="blog-body">
              <div class="blog-meta">
                <span class="blog-date">{formatDate(post.data.date)}</span>
                <div class="blog-tags">
                  {post.data.tags.map((tagLabel) => (
                    <span class="tag" data-tag={slugifyTag(tagLabel)}>{tagLabel}</span>
                  ))}
                </div>
              </div>
              <h2 class="blog-title">
                <a href={`/blog/${post.slug}`}>{post.data.title}</a>
              </h2>
              <p class="blog-excerpt">{excerptFor(post)}</p>
              <a class="card-link" href={`/blog/${post.slug}`}>Read more -&gt;</a>
            </div>
          </article>
        ))}
      </div>
    )}
  </section>
</BaseLayout>
